---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BookCard from '../../components/BookCard.astro';
import SearchBar from '../../components/SearchBar.astro';
import booksData from '../../data/books.json';

const { categories, books: allBooks } = booksData;
---

<BaseLayout
  title="الكتب"
  titleTi="መጻሕፍቲ"
  description="مكتبة إسلامية شاملة - كتب PDF للتحميل المجاني"
>
  <!-- Page Header -->
  <section class="hero-gradient text-white py-16">
    <div class="container text-center">
      <div class="trilingual-title items-center mb-6">
        <h1 class="ar text-4xl font-bold text-white">المكتبة الإسلامية</h1>
        <p class="en text-xl text-accent font-medium">Islamic Library</p>
        <p class="ti text-lg text-white/80 font-ethiopic">እስላማዊ ቤተ-መጻሕፍቲ</p>
      </div>
      <p class="text-lg opacity-90 max-w-2xl mx-auto mb-4">
        كتب إسلامية قيمة للتحميل المجاني - عقيدة، فقه، حديث، تفسير، سيرة
      </p>
      <p class="text-base opacity-75 max-w-2xl mx-auto mb-8">
        Free Islamic books download - Aqeedah, Fiqh, Hadith, Tafsir, Seerah
      </p>
      <div class="flex justify-center">
        <SearchBar placeholder="ابحث في الكتب..." />
      </div>
    </div>
  </section>

  <!-- Category Filter -->
  <section class="bg-white border-b border-cream-dark sticky top-16 z-40">
    <div class="container py-4">
      <div class="flex flex-wrap gap-2 justify-center">
        {categories.map((cat) => (
          <button
            class="category-btn px-4 py-2 rounded-full text-sm font-medium transition-colors border-2 border-transparent hover:border-primary data-[active]:bg-primary data-[active]:text-white"
            data-category={cat.id}
            data-active={cat.id === 'all' ? '' : undefined}
          >
            <span>{cat.labelAr}</span>
            <span class="text-xs opacity-70 mr-1 font-ethiopic">({cat.labelTi})</span>
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Books Grid -->
  <section class="py-12 bg-cream">
    <div class="container">
      <div class="flex items-center justify-between mb-8">
        <p class="text-text-light">
          عرض <span class="font-bold text-primary">{allBooks.length}</span> كتاب
        </p>
        <select id="sort-select" class="bg-white border border-cream-dark rounded-lg px-4 py-2 text-sm focus:border-primary focus:outline-none">
          <option value="newest">الأحدث أولاً</option>
          <option value="alphabetical">أبجدياً</option>
          <option value="pages">حسب عدد الصفحات</option>
        </select>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="books-grid">
        {allBooks.map((book, index) => (
          <div class="book-item" data-category={book.category} data-title={book.titleAr} data-pages={book.pages || 0} data-index={index}>
            <BookCard {...book} />
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Upload CTA -->
  <section class="py-12 bg-white">
    <div class="container text-center">
      <div class="trilingual-title items-center mb-4">
        <h2 class="ar text-2xl font-bold text-text-dark">شارك كتاباً</h2>
        <p class="en text-lg text-primary font-medium">Share a Book</p>
        <p class="ti text-base text-text-light font-ethiopic">መጽሓፍ ኣካፍሉ</p>
      </div>
      <p class="text-text-light mb-4">
        هل لديك كتاب إسلامي مفيد تريد مشاركته؟ تواصل معنا
      </p>
      <p class="text-sm text-text-light mb-6">
        Have an Islamic book you'd like to share? Contact us
      </p>
      <a href="/contact" class="btn btn-primary">
        تواصل معنا | Contact Us
      </a>
    </div>
  </section>
</BaseLayout>

<script>
  const categoryBtns = document.querySelectorAll('.category-btn');
  const bookItems = document.querySelectorAll('.book-item');
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  const booksGrid = document.getElementById('books-grid');

  // Filter function
  function filterByCategory(category: string) {
    categoryBtns.forEach(b => b.removeAttribute('data-active'));
    const activeBtn = document.querySelector(`[data-category="${category}"]`);
    activeBtn?.setAttribute('data-active', '');

    bookItems.forEach(item => {
      if (category === 'all' || item.getAttribute('data-category') === category) {
        (item as HTMLElement).style.display = 'block';
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });
  }

  // Check URL for category parameter
  const urlParams = new URLSearchParams(window.location.search);
  const categoryParam = urlParams.get('category');
  if (categoryParam) {
    filterByCategory(categoryParam);
  }

  // Category filtering on click
  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category') || 'all';
      filterByCategory(category);
    });
  });

  // Sorting functionality
  sortSelect?.addEventListener('change', () => {
    const sortValue = sortSelect.value;
    const items = Array.from(bookItems) as HTMLElement[];

    items.sort((a, b) => {
      if (sortValue === 'alphabetical') {
        const titleA = a.getAttribute('data-title') || '';
        const titleB = b.getAttribute('data-title') || '';
        return titleA.localeCompare(titleB, 'ar');
      } else if (sortValue === 'pages') {
        const pagesA = parseInt(a.getAttribute('data-pages') || '0');
        const pagesB = parseInt(b.getAttribute('data-pages') || '0');
        return pagesB - pagesA; // Most pages first
      } else {
        // newest - sort by original index
        const indexA = parseInt(a.getAttribute('data-index') || '0');
        const indexB = parseInt(b.getAttribute('data-index') || '0');
        return indexA - indexB;
      }
    });

    // Re-append items in new order
    items.forEach(item => booksGrid?.appendChild(item));
  });
</script>

<script is:inline>
  // PDF.js Preview Renderer
  document.addEventListener('DOMContentLoaded', async () => {
    if (typeof pdfjsLib === 'undefined') {
      console.warn('PDF.js not loaded');
      return;
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const canvases = document.querySelectorAll('canvas[data-pdf-url]');

    for (const canvas of canvases) {
      const pdfUrl = canvas.getAttribute('data-pdf-url');
      const container = canvas.closest('.pdf-preview-container');

      try {
        const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
        const page = await pdf.getPage(1);

        const containerWidth = canvas.parentElement?.clientWidth || 176;
        const containerHeight = canvas.parentElement?.clientHeight || 224;

        const viewport = page.getViewport({ scale: 1 });
        const scaleX = containerWidth / viewport.width;
        const scaleY = containerHeight / viewport.height;
        const scale = Math.min(scaleX, scaleY) * 1.5;

        const scaledViewport = page.getViewport({ scale });

        canvas.width = scaledViewport.width;
        canvas.height = scaledViewport.height;

        const ctx = canvas.getContext('2d');
        await page.render({
          canvasContext: ctx,
          viewport: scaledViewport
        }).promise;

        if (container) {
          container.classList.add('loaded');
        }
      } catch (error) {
        console.error('Error loading PDF preview:', pdfUrl, error);
      }
    }
  });
</script>

<style>
  .font-ethiopic {
    font-family: var(--font-ethiopic);
  }
</style>
